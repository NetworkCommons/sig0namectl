<!DOCTYPE html>
<html lang='en'>
<head>
    <base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mapping DNS Location Entries</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/dohjs@latest/dist/doh.min.js"></script>
    <script>
        /// Uint32 helper Class for byte conversion
        class Uint32
        {
            constructor(Value) 
            {
                this.Number = new Uint32Array(1);
                this.Number[0] = Value;
            }
            get Get() 
            {
                return this.Number[0];
            }
            set Set(newValue) 
            {
                this.Number[0] = newValue;
            }
        };

        /// Convert u8 Byte array from network byte order (big-endian) to 32bit unsigned integer (little-endian)
        function ntoh_Uint32 (Source_Byte_Array, Start_Position)
        {
            var Uint32_Num = new Uint32(0);
            var Multiplier = 1;
            for (let i = 3; i >= 0; i--)
            {
                Uint32_Num.Set = Uint32_Num.Get + Source_Byte_Array[Start_Position + i] * Multiplier;
                Multiplier = Multiplier * 256;
            }
            return (Uint32_Num.Get);
        }

    </script>
    <style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 100%;
			width: 100%;
			max-width: 100%;
			max-height: 100%;
		}
	</style>
</head>
<body>
    <div id="map" style="width: 100%; height: 100%;"></div>
    <script>
        // initialize map and set focus on Berlin
        var map = L.map('map').setView([52.52047, 13.41003], 13);

        // set tile layer
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // create resolver
        //
        // There are many different possible public resolvers:
        // https://dnsprivacy.org/public_resolvers/#dns-over-https-doh
        const resolver = new doh.DohResolver('https://1.1.1.1/dns-query');
        // const resolver = new doh.DohResolver('https://zembla.zenr.io/dns-query');

        // -------------------------------------------------------

        /// Receive Service Pointers
        function get_service_pointers (domain) {
            var query_domain = "_loc._udp." + domain;

            console.log("PTR records of " + query_domain);

            resolver.query(query_domain, 'PTR')
                .then(response => {
                    response.answers.forEach(ans => {
                        console.log(ans.data);
                        to_query.add(ans.data);
                    });

                    to_query.query();
                });
        }

        /// Collection of Domains to query
        class ToQuery {
            constructor(domains) {
                // array of Domain objects
                this.domains = domains;
            }

            /// add a new domain entry via domain name
            add(domain_name) {
                let domain = new Domain(domain_name);
                this.domains.push(domain);
            }

            /// query domains for LOC entries
            query() {
                console.log("query update ...");
                this.domains.forEach( domain => {
                    domain.query();
                });
            }
        };

        /// Domain
        class Domain {
            constructor(name) {
                this.name = name;
                this.entries = [];
            }

            /// query the LOC records of a domain
            query() {
                resolver.query(this.name, 'LOC')
                    .then(response => {
                        var id = 0;
                        response.answers.forEach(ans => {
                            // create latitude Uint32
                            let latitude_raw = ntoh_Uint32(ans.data, 4);
                            let latitude = (latitude_raw - 2147483648.0) / 3600000;

                            // create longitude Uint32
                            let longitude_raw = ntoh_Uint32(ans.data, 8);
                            let longitude = (longitude_raw - 2147483648.0) / 3600000;

                            // update marker on map
                            this.update_marker(latitude, longitude, id);
                            id++;
                        });
                    })
                    .catch(err => console.error(err));
            }

            /// update marker on map
            ///
            /// the map ID is the answer number
            update_marker(latitude, longitude, id) {
                // check if marker exists
                if (this.entries.length > id) {
                    // update position
                    let latLng = new L.LatLng(latitude, longitude);
                    this.entries[id].setLatLng(latLng);

                    // update popup text
                    let popup_text = this.create_popup_text(latitude, longitude);
                    this.entries[id].setPopupContent(popup_text);
                } else {
                    // set new map point
                    this.create_marker(latitude, longitude);
                }
            }

            /// create new map marker
            create_marker(latitude, longitude) {
                // set point of interest on map
                let marker = L.marker([latitude, longitude]).addTo(map);

                // set explanatory pop-up
                let popup_text = this.create_popup_text(latitude, longitude);
                marker.bindPopup(popup_text);

                // add to entries
                this.entries.push(marker);
            }

            /// create popup text
            create_popup_text(latitude, longitude) {
                let popup_text = "<b>" + this.name + "</b>";
                popup_text += "<hr>Latitude: " + latitude;
                popup_text += "<br>Longitude: " + longitude;
                
                return popup_text;
            }

            /// Trim location array to defined length
            trim_entries(length) {
                while(length > this.entries.length()) {
                    this.entries.pop();
                }
            }
        }

        function timer_query() {
            to_query.query();
        }

        // -------------------------------------------------------

        // set Domains object
        var to_query = new ToQuery([]);
        get_service_pointers("zembla.zenr.io");
        setInterval(timer_query, 10000);
    </script>
</body>
</html>
