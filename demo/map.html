<!DOCTYPE html>
<html lang='en'>
<head>
    <base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mapping DNS Location Entries</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/dohjs@latest/dist/doh.min.js"></script>
    <script>
        /// Uint32 helper Class for byte conversion
        class Uint32
        {
            constructor(Value) 
            {
                this.Number = new Uint32Array(1);
                this.Number[0] = Value;
            }
            get Get() 
            {
                return this.Number[0];
            }
            set Set(newValue) 
            {
                this.Number[0] = newValue;
            }
        };

        /// Convert u8 Byte array from network byte order (big-endian) to 32bit unsigned integer (little-endian)
        function ntoh_Uint32 (Source_Byte_Array, Start_Position)
        {
            var Uint32_Num = new Uint32(0);
            var Multiplier = 1;
            for (let i = 3; i >= 0; i--)
            {
                Uint32_Num.Set = Uint32_Num.Get + Source_Byte_Array[Start_Position + i] * Multiplier;
                Multiplier = Multiplier * 256;
            }
            return (Uint32_Num.Get);
        }

    </script>
    <style>
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 100%;
			width: 100%;
			max-width: 100%;
			max-height: 100%;
		}
	</style>
</head>
<body>
    <div id="map" style="width: 100%; height: 100%;"></div>
    <script>
        // initialize map and set focus on Berlin
        var map = L.map('map').setView([52.52047, 13.41003], 13);

        // set tile layer
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // --------------------------------------------------
        // query DoH server
        // --------------------------------------------------

        // create resolver
        const resolver = new doh.DohResolver('https://1.1.1.1/dns-query');

        // domain to query
        var domain = 'redb.zenr.io';

        // get DNS LOC entry
        resolver.query(domain, 'LOC')
            .then(response => {
                response.answers.forEach(ans => {
                    // log Uint8Array
                    console.log(ans.data);

                    // create latitude Uint32
                    let latitude_raw = ntoh_Uint32(ans.data, 4);
                    let latitude = (latitude_raw - 2147483648.0) / 3600000;
                    console.log(latitude);

                    // create longitude Uint32
                    let longitude_raw = ntoh_Uint32(ans.data, 8);
                    let longitude = (longitude_raw - 2147483648.0) / 3600000;
                    console.log(longitude);

                    // set point of interest on map
                    var marker = L.marker([latitude, longitude]).addTo(map);

                    // set explanatory pop-up
                    var popup_text = "<b>" + domain + " DNS LOC Entry</b>";
                    popup_text += "<hr>Latitude: " + latitude;
                    popup_text += "<br>Longitude: " + longitude;
                    marker.bindPopup(popup_text).openPopup();
                });
            })
            .catch(err => console.error(err));
    </script>
</body>
</html>